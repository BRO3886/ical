# Journal Entry 001 - 2026-02-11 - Initial Build: Complete CLI from Scratch

## Goal
Build the complete `cal` CLI from a blank repo (empty directory scaffolding only) to a fully working macOS Calendar CLI per the PRD. All commands, tests, README, LICENSE. Push to private repo on BRO3886.

## What Changed
- **Project scaffolding**: `go.mod` (github.com/BRO3886/cal), `main.go` with macOS guard + ldflags version, `root.go` with `--output`/`--no-color` global flags, `Makefile` with build/test/install/completions targets
- **Date parser** (`internal/parser/date.go`): Adapted from `rem` project's parser. Key changes from rem: accepts a `now` parameter via `ParseDateRelativeTo()` for testable parsing, defaults dates to 00:00 instead of 09:00 (calendar vs reminders), added "X ago" support, month+day parsing (`mar 15`), standalone weekday parsing, "eow" as same-Friday when on Friday
- **Output formatting** (`internal/ui/output.go`): Table (tablewriter v1.x new API), JSON, plain formats. `localizeTime()` converts UTC times from EventKit to event's timezone or local fallback
- **All 12 commands**: calendars, list, today, upcoming, show, add, update, delete, search, export, import, version — plus cobra completion built-in
- **Export/import** (`internal/export/`): JSON, CSV, ICS (RFC 5545) export. JSON + CSV import with `--dry-run`
- **`--exclude-calendar`** flag on list/today/upcoming: case-insensitive exclusion of noisy calendars
- **Tests**: 80+ parser tests (93.2% coverage), 12 export tests (60.1%), 6 UI tests. Timezone edge cases: DST transitions (spring forward/fall back), half-hour offsets (IST UTC+5:30, Nepal UTC+5:45), international date line (Auckland, Samoa), negative UTC offsets (Hawaii), year/month boundaries, leap years, midnight boundaries
- **README.md** with full documentation, **LICENSE** (MIT)
- Pushed to private repo `github.com/BRO3886/cal`

## Key Insights
- **EventKit returns UTC times**: All `StartDate`/`EndDate` from go-eventkit are in UTC. Must convert to local time for display. Used `localizeTime()` that checks event's `TimeZone` field first, falls back to `time.Local`. This was a bug in the first build — times showed as UTC (04:30 instead of 10:00 IST).
- **`.gitignore` `cal` entry matched `cmd/cal/`**: Had to change `cal` to `/cal` to only ignore the binary at root, not the entire `cmd/cal/` directory.
- **Prefix ID matching**: Events from EventKit share common prefix UUIDs within the same source (e.g., `7E799987-...` prefixed all iCloud events in testing). Need to use the full colon-separated ID format for reliable matching. The `findEventByPrefix()` searches a +-1 year window for matches.
- **tablewriter v1.x API**: Uses `NewTable()`, `.Header()`, `.Append()`, `.Render()` — NOT the old `SetHeader()`/`SetBorder()` API. Alignment via `tw.CellConfig{Formatting: tw.CellFormatting{Alignment: tw.AlignLeft}}`.
- **`calendar.Alert.RelativeOffset`**: Negative means before event. When creating, pass `-duration`. When displaying, negate to get positive.
- **Recurrence `Weekday.String()`**: Returns lowercase (`"mon"`, `"wed"`), not title case. Tests must match this.

## Decisions Made
- **Parser adapted from rem, not copied**: rem's parser uses `time.Now()` internally and defaults to 9 AM. For cal, added `ParseDateRelativeTo()` that accepts `now` for testability, and defaults to 00:00 (calendar events need explicit times).
- **`--exclude-calendar` as StringArray**: Allows `--exclude-calendar Birthdays --exclude-calendar "US Holidays"` syntax. Case-insensitive matching for user convenience.
- **No interactive mode yet**: Deferred `-i` flag for add/update to keep initial build focused. Can add in Phase 3.
- **Event prefix search window**: +-1 year from now. Could be made configurable but covers most use cases without performance issues.

---

## Session 2 - Interactive Mode with charmbracelet/huh

### Goal
Implement `-i`/`--interactive` flag on `add` and `update` commands for guided event creation/editing, using `charmbracelet/huh` for a modern form-based TUI.

### What Changed
- **`cmd/cal/commands/add.go`**: Added `--interactive`/`-i` flag. `runAddInteractive()` presents a 3-page `huh.Form`:
  - Page 1 (Essentials): Title (validated non-empty), Calendar (`huh.Select` from writable cals), Start (validated with `parser.ParseDate`), End (optional, defaults to start+1h), All-day (`huh.Confirm`)
  - Page 2 (Details): Location, Notes, URL, Alerts (comma-separated string like `15m, 1h`), Timezone (validated with `time.LoadLocation`)
  - Page 3 (Recurrence): Repeat frequency (`Select`: none/daily/weekly/monthly/yearly), Repeat days (for weekly)
  - `buildCalendarOptions()` helper builds `huh.Option[string]` list filtering out read-only calendars
- **`cmd/cal/commands/update.go`**: Added `--interactive`/`-i` flag. `runUpdateInteractive()` pre-fills all form fields with current event values:
  - Same 3-page structure as add, plus a span page for recurring events (`Select`: "This event only" / "This and future events")
  - Only changed fields are sent in `UpdateEventInput` (nil for unchanged)
  - Type `-` in Location/Notes/URL to explicitly clear a field
  - `buildAlertSummary()` and `formatAlertDurationShort()` for displaying current alerts
  - `localizeEventTime()` for converting EventKit UTC times to display
- **Initially created `helpers.go`**, then removed it — inlined the 3 functions into add.go and update.go since they were small and only used in one or two places
- Flag-based mode on both commands is completely unchanged

### Key Insights
- **Started with `bufio.NewReader`** (matching `rem` pattern), user preferred `charmbracelet/huh` for better UX — arrow-key selection, inline validation, multi-page forms
- **`huh.ErrUserAborted`** is returned on Ctrl+C — must handle gracefully instead of returning as error
- **`huh.NewOption(label, value).Selected(true)`** pre-selects the current calendar in update mode
- **Alerts as comma-separated string** rather than multi-prompt loop — simpler with huh since it's a single Input field. Parsed after form submission with `strings.Split` + `parser.ParseAlertDuration`
- **Theme**: Using `huh.ThemeCatppuccin()` for consistent styling
- **Separate helpers file wasn't needed** — only 3 small functions, better to colocate with usage

### Decisions Made
- **`charmbracelet/huh` over `bufio`/`promptui`/`survey`**: User chose huh for modern Charm ecosystem UX. Adds ~15 transitive deps but provides Select menus, inline validation, and form-based flow
- **No separate helpers file**: Functions are small enough to live in the files that use them. `buildCalendarOptions` in add.go (also used conceptually in update.go but each file imports huh independently), alert helpers in update.go
- **Alerts as single comma-separated input**: Rather than a loop for multiple alerts, a single field with comma separation works better with huh's form model
- **Recurrence simplified in interactive mode**: No interval/until/count prompts — just frequency + days. Users needing fine-grained recurrence control can use flags directly

---
