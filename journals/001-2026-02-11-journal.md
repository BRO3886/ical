# Journal Entry 001 - 2026-02-11 - Initial Build: Complete CLI from Scratch

## Goal

Build the complete `cal` CLI from a blank repo (empty directory scaffolding only) to a fully working macOS Calendar CLI per the PRD. All commands, tests, README, LICENSE. Push to private repo on BRO3886.

## What Changed

- **Project scaffolding**: `go.mod` (github.com/BRO3886/cal), `main.go` with macOS guard + ldflags version, `root.go` with `--output`/`--no-color` global flags, `Makefile` with build/test/install/completions targets
- **Date parser** (`internal/parser/date.go`): Adapted from `rem` project's parser. Key changes from rem: accepts a `now` parameter via `ParseDateRelativeTo()` for testable parsing, defaults dates to 00:00 instead of 09:00 (calendar vs reminders), added "X ago" support, month+day parsing (`mar 15`), standalone weekday parsing, "eow" as same-Friday when on Friday
- **Output formatting** (`internal/ui/output.go`): Table (tablewriter v1.x new API), JSON, plain formats. `localizeTime()` converts UTC times from EventKit to event's timezone or local fallback
- **All 12 commands**: calendars, list, today, upcoming, show, add, update, delete, search, export, import, version — plus cobra completion built-in
- **Export/import** (`internal/export/`): JSON, CSV, ICS (RFC 5545) export. JSON + CSV import with `--dry-run`
- **`--exclude-calendar`** flag on list/today/upcoming: case-insensitive exclusion of noisy calendars
- **Tests**: 80+ parser tests (93.2% coverage), 12 export tests (60.1%), 6 UI tests. Timezone edge cases: DST transitions (spring forward/fall back), half-hour offsets (IST UTC+5:30, Nepal UTC+5:45), international date line (Auckland, Samoa), negative UTC offsets (Hawaii), year/month boundaries, leap years, midnight boundaries
- **README.md** with full documentation, **LICENSE** (MIT)
- Pushed to private repo `github.com/BRO3886/cal`

## Key Insights

- **EventKit returns UTC times**: All `StartDate`/`EndDate` from go-eventkit are in UTC. Must convert to local time for display. Used `localizeTime()` that checks event's `TimeZone` field first, falls back to `time.Local`. This was a bug in the first build — times showed as UTC (04:30 instead of 10:00 IST).
- **`.gitignore` `cal` entry matched `cmd/cal/`**: Had to change `cal` to `/cal` to only ignore the binary at root, not the entire `cmd/cal/` directory.
- **Prefix ID matching**: Events from EventKit share common prefix UUIDs within the same source (e.g., `7E799987-...` prefixed all iCloud events in testing). Need to use the full colon-separated ID format for reliable matching. The `findEventByPrefix()` searches a +-1 year window for matches.
- **tablewriter v1.x API**: Uses `NewTable()`, `.Header()`, `.Append()`, `.Render()` — NOT the old `SetHeader()`/`SetBorder()` API. Alignment via `tw.CellConfig{Formatting: tw.CellFormatting{Alignment: tw.AlignLeft}}`.
- **`calendar.Alert.RelativeOffset`**: Negative means before event. When creating, pass `-duration`. When displaying, negate to get positive.
- **Recurrence `Weekday.String()`**: Returns lowercase (`"mon"`, `"wed"`), not title case. Tests must match this.

## Decisions Made

- **Parser adapted from rem, not copied**: rem's parser uses `time.Now()` internally and defaults to 9 AM. For cal, added `ParseDateRelativeTo()` that accepts `now` for testability, and defaults to 00:00 (calendar events need explicit times).
- **`--exclude-calendar` as StringArray**: Allows `--exclude-calendar Birthdays --exclude-calendar "US Holidays"` syntax. Case-insensitive matching for user convenience.
- **No interactive mode yet**: Deferred `-i` flag for add/update to keep initial build focused. Can add in Phase 3.
- **Event prefix search window**: +-1 year from now. Could be made configurable but covers most use cases without performance issues.

---

## Session 2 - Interactive Mode with charmbracelet/huh

### Goal

Implement `-i`/`--interactive` flag on `add` and `update` commands for guided event creation/editing, using `charmbracelet/huh` for a modern form-based TUI.

### What Changed

- **`cmd/cal/commands/add.go`**: Added `--interactive`/`-i` flag. `runAddInteractive()` presents a 3-page `huh.Form`:
  - Page 1 (Essentials): Title (validated non-empty), Calendar (`huh.Select` from writable cals), Start (validated with `parser.ParseDate`), End (optional, defaults to start+1h), All-day (`huh.Confirm`)
  - Page 2 (Details): Location, Notes, URL, Alerts (comma-separated string like `15m, 1h`), Timezone (validated with `time.LoadLocation`)
  - Page 3 (Recurrence): Repeat frequency (`Select`: none/daily/weekly/monthly/yearly), Repeat days (for weekly)
  - `buildCalendarOptions()` helper builds `huh.Option[string]` list filtering out read-only calendars
- **`cmd/cal/commands/update.go`**: Added `--interactive`/`-i` flag. `runUpdateInteractive()` pre-fills all form fields with current event values:
  - Same 3-page structure as add, plus a span page for recurring events (`Select`: "This event only" / "This and future events")
  - Only changed fields are sent in `UpdateEventInput` (nil for unchanged)
  - Type `-` in Location/Notes/URL to explicitly clear a field
  - `buildAlertSummary()` and `formatAlertDurationShort()` for displaying current alerts
  - `localizeEventTime()` for converting EventKit UTC times to display
- **Initially created `helpers.go`**, then removed it — inlined the 3 functions into add.go and update.go since they were small and only used in one or two places
- Flag-based mode on both commands is completely unchanged

### Key Insights

- **Started with `bufio.NewReader`** (matching `rem` pattern), user preferred `charmbracelet/huh` for better UX — arrow-key selection, inline validation, multi-page forms
- **`huh.ErrUserAborted`** is returned on Ctrl+C — must handle gracefully instead of returning as error
- **`huh.NewOption(label, value).Selected(true)`** pre-selects the current calendar in update mode
- **Alerts as comma-separated string** rather than multi-prompt loop — simpler with huh since it's a single Input field. Parsed after form submission with `strings.Split` + `parser.ParseAlertDuration`
- **Theme**: Using `huh.ThemeCatppuccin()` for consistent styling
- **Separate helpers file wasn't needed** — only 3 small functions, better to colocate with usage

### Decisions Made

- **`charmbracelet/huh` over `bufio`/`promptui`/`survey`**: User chose huh for modern Charm ecosystem UX. Adds ~15 transitive deps but provides Select menus, inline validation, and form-based flow
- **No separate helpers file**: Functions are small enough to live in the files that use them. `buildCalendarOptions` in add.go (also used conceptually in update.go but each file imports huh independently), alert helpers in update.go
- **Alerts as single comma-separated input**: Rather than a loop for multiple alerts, a single field with comma separation works better with huh's form model
- **Recurrence simplified in interactive mode**: No interval/until/count prompts — just frequency + days. Users needing fine-grained recurrence control can use flags directly

---

## Session 3 - Event ID Visibility & Disambiguation

### Goal

Fix the critical UX gap where `cal list`/`today`/`upcoming` showed no event IDs, making it impossible to use `cal show`/`update`/`delete` without guessing. Also fix ID prefix collisions where events from the same source share the first 8 chars of their UUID.

### What Changed

- **`internal/ui/output.go`**: Added "ID" column to `printEventsTable()` as the first column. Added short ID prefix to `printEventsPlain()` output lines. Both use `ShortID()`.
- **`ShortID()` increased from 8 to 13 chars**: Now covers two UUID segments (e.g. `577B8983-DF44`) instead of just the first (`577B8983`). This disambiguates events from the same source — the first segment is shared across all events from a given EventKit source (iCloud, Google, etc.).
- **`cmd/cal/commands/show.go`**: Disambiguation message in `findEventByPrefix()` now shows 22 chars (3 UUID segments) instead of 8, so users can copy a longer prefix when multiple events still match.
- **`internal/ui/output_test.go`**: Updated `TestShortID` cases for 13-char length, added real-world UUID test case.
- **`internal/parser/date.go`**: Added `"this week"` keyword (Sunday 23:59, distinct from `"eow"` which targets Friday 5pm). Added comprehensive doc comment to `ParseDateRelativeTo()` listing all supported input formats. Improved error message with more examples.
- **`internal/parser/date_test.go`**: Added tests for `"this week"` keyword covering weekday, Saturday, and Sunday edge cases.

### Key Insights

- **8-char short IDs are useless for same-source events**: EventKit event IDs are structured as `<source-UUID>:<event-specific-part>`. All events from Google Calendar shared prefix `577B8983`, making `ShortID` identical. The second UUID segment (`-DF44`, `-966E`, etc.) is where they diverge.
- **13 chars is the sweet spot**: Covers `XXXXXXXX-XXXX` (two UUID segments with hyphen separator). Enough to disambiguate without cluttering the table. The disambiguation fallback shows 22 chars for the rare case of further collision.
- **JSON output already had full IDs**: Only table and plain formats were missing IDs.

### Decisions Made

- **13-char short ID over variable-length**: Considered dynamic length based on collision detection, but fixed 13 chars is simpler and sufficient — the second UUID segment provides enough entropy.
- **22-char disambiguation display**: When multiple events match a prefix, show 3 UUID segments so users can always pick a unique prefix. This is only shown in the error path so longer IDs are acceptable.
- **ID as first column in table**: Placed before Time since it's the primary key users need for further commands. Easy to spot and copy.

---

## Session 4 - Row Numbers + Interactive Event Picker

### Goal

Fix the fundamental problem that EventKit event IDs share UUID prefixes within the same calendar, making short ID display useless for disambiguation. Went through multiple iterations before landing on the right approach.

### What Changed

- **`internal/ui/output.go`**: Table now shows `#1`, `#2`, `#3`... row numbers instead of UUID fragments. Plain output prefixes lines with `#1`, `#2`, etc. Added `SaveLastList()` to cache event IDs to `~/.cal-last-list` (one ID per line). Added `LookupRowNumber(n)` to read back by 1-based index. `PrintEvents()` calls `SaveLastList()` on every invocation.
- **`cmd/cal/commands/show.go`**: Accepts 0 or 1 args. 0 args → `pickEvent()` interactive huh.Select picker. 1 arg → row number lookup → exact ID → prefix match (fallback chain). Added `--from`/`--to`/`--days` flags to scope the picker's date range.
- **`cmd/cal/commands/delete.go`**: Same 0-or-1-arg pattern. Contains the shared `pickEvent()` function that builds a `huh.Select` from events in a date range. Added `--from`/`--to`/`--days` flags.
- **`cmd/cal/commands/update.go`**: Same 0-or-1-arg pattern, delegates to `pickEvent()` when no arg given. Args changed from `ExactArgs(1)` to `MaximumNArgs(1)`.
- **`internal/ui/output_test.go`**: Updated `TestShortID` for 13-char length (ShortID still used by `PrintCreatedEvent`/`PrintUpdatedEvent`).

### Key Insights

- **8-char AND 13-char short IDs both fail**: The entire UUID before the colon (36 chars: `577B8983-DF44-4665-966E-58129A363B3A`) is the **calendar** identifier, shared by ALL events in that calendar. The event-specific part is only after the `:`. No fixed-length prefix works.
- **Row numbers + cache file is pragmatic**: `~/.cal-last-list` maps row numbers to full IDs. Works well for sequential CLI use (list → show 3) and for programmatic consumers like Claude. Weakness: stale across terminals/time, but acceptable since the interactive picker exists as fallback.
- **`pickEvent()` is the shared interactive picker**: Lives in `delete.go` (arbitrary, but avoids a new file). Takes `client`, `fromStr`, `toStr`, `days` params. Returns `(*calendar.Event, error)` where nil event means user cancelled. Used by show, delete, and update.
- **Three identification strategies coexist**: (1) interactive picker for humans, (2) row numbers for quick sequential use, (3) full/partial IDs for scripting. `findEventByPrefix()` tries row number → exact match → prefix search as a fallback chain.
- **Cobra `(default N)` duplication**: If you write `"description (default 7)"` and the flag has a default of 7, cobra prints `(default 7)` twice. Don't include defaults in flag descriptions.

### Decisions Made

- **Row numbers over short IDs in table**: Short IDs are fundamentally broken for same-calendar events. Row numbers are always unique within a listing and trivially map to the cache.
- **Cache file over in-memory state**: CLI is stateless between invocations. A simple text file (`~/.cal-last-list`) with one ID per line is the minimal approach. No JSON, no metadata, no TTL — just IDs indexed by line number.
- **`pickEvent()` in delete.go, not a separate file**: Only 3 functions use it. Avoids file proliferation. Could move to a shared file later if more commands need it.
- **`localizeEventTime()` stays duplicated**: Exists in both `update.go` and `ui/output.go` (as unexported `localizeTime`). Not worth exporting for 4 lines of code.
- **Default picker window is 7 days**: Broad enough to show relevant events, narrow enough to not overwhelm the huh.Select list.

---

## Session 5 - Fix --to Date Range Boundary Bug

### Goal

Fix a bug where `--to "feb 12"` excluded events on Feb 12 itself. An event at 12:30 AM EST on Feb 12 (stored as `2026-02-12T05:30:00Z` in EventKit) was invisible with `--to "feb 12"` but appeared with `--to "feb 13"`.

### What Changed

- **`cmd/cal/commands/list.go`**: Added `endOfDayIfMidnight()` helper that bumps midnight timestamps to 23:59:59. Applied to `--to` parsing in `listCmd`.
- **`cmd/cal/commands/search.go`**: Applied `endOfDayIfMidnight()` to `--to` parsing.
- **`cmd/cal/commands/export.go`**: Applied `endOfDayIfMidnight()` to `--to` parsing.
- **`cmd/cal/commands/delete.go`**: Applied `endOfDayIfMidnight()` to `--to` parsing in `pickEvent()`.

### Key Insights

- **Root cause**: `parser.ParseDate("feb 12")` returns `Feb 12 00:00:00 local` (IST). EventKit queries with `to=Feb 12 00:00 IST` (= `Feb 11 18:30 UTC`) exclude an event starting at `Feb 12 05:30 UTC`. The user expects `--to "feb 12"` to mean "through the end of Feb 12", not "up to the start of Feb 12".
- **Why the parser can't fix this**: The parser doesn't know whether a date is being used as a `--from` (should be midnight) or `--to` (should be end-of-day). The fix belongs in the command layer.
- **`endOfDayIfMidnight` only triggers for midnight**: If the user provides an explicit time like `--to "feb 12 3pm"`, it's left as-is. The heuristic is: midnight = "user specified a date without a time" = bump to end of day.

```go
func endOfDayIfMidnight(t time.Time) time.Time {
    if t.Hour() == 0 && t.Minute() == 0 && t.Second() == 0 {
        return time.Date(t.Year(), t.Month(), t.Day(), 23, 59, 59, 0, t.Location())
    }
    return t
}
```

- **Comprehensive fix**: Applied to all 4 commands that accept `--to`: `list`, `search`, `export`, `pickEvent` (shared by show/delete/update). Did NOT apply to `--from`, `--start`, `--end` on add/update — those are specific event times, not range boundaries.

### Decisions Made

- **23:59:59 not next-day 00:00**: Using end-of-day rather than start-of-next-day avoids accidentally including events that start at exactly midnight of the next day. 1-second gap is negligible.
- **Fix in command layer, not parser**: Keeps the parser pure — it returns what the input says. The semantic meaning of "end of range" is the caller's responsibility.

---

## Session 6 - Documentation Website

## Goal

Create a documentation website for `cal` using Hugo, deploy to Cloudflare Pages, and set up CI/CD with GitHub Actions. Modeled after the `rem` project's docs site but with an Apple Calendar-inspired red color scheme.

## What Changed

- **Hugo site** (`website/`): Full static site with custom `cal-docs` theme
  - Config: `website/config.yaml` with markdown output format for raw `.md` access
  - Theme: `website/themes/cal-docs/` with layouts, CSS, JS, favicon
  - Content: 4 documentation pages + home + docs index
- **Theme design**: Apple-inspired with red calendar accent (`#E03E3E` light, `#ff6b6b` dark)
  - Light/dark mode toggle with localStorage persistence
  - Frosted glass navbar with backdrop blur
  - Scroll-reveal animations on feature cards
  - Terminal typing animation demo on home page
  - Responsive layout (3-col → 2-col → 1-col grid, collapsible sidebar)
- **Documentation content**:
  - `getting-started.md`: Installation, first run, basic usage, output formats, shell completions
  - `commands.md`: Complete reference for all 13 commands with flags and examples
  - `date-parsing.md`: Natural language date input reference with all 20+ patterns
  - `architecture.md`: EventKit bindings, project structure, design decisions, limitations
- **Copy buttons**: Auto-injected via JS on all `<pre>` code blocks in docs pages, plus manual copy buttons on install section
- **MD raw output**: Hugo generates both HTML and raw markdown for each page (accessible at `/docs/page/index.md`), with sitemap entries for markdown URLs
- **Favicon**: SVG calendar icon — red rounded square with calendar strip and "11" date
- **CI/CD**:
  - `.github/workflows/deploy.yml`: Triggers on `website/**` or workflow changes, builds with Hugo 0.139.0, deploys via wrangler
  - GitHub secrets: `CLOUDFLARE_API_TOKEN` and `CLOUDFLARE_ACCOUNT_ID` pushed to repo
  - Cloudflare Pages project `cal` created, initial deploy successful
- **README.md**: Added documentation link section
- **CLAUDE.md**: Added Documentation Website section with deploy details
- **MEMORY.md**: Added website documentation section

## Key Insights

- Hugo 0.92 (installed locally) built the site fine, but the GH Action uses 0.139.0 for consistency with the rem project
- Cloudflare Pages project URL: `cal-3gu.pages.dev` (to be mapped to `cal.sidv.dev`)
- The `mediaTypes` + `outputFormats` + `outputs` config in Hugo enables dual HTML+MD generation per page — key for agent-accessible raw markdown
- Code block copy buttons are injected dynamically in JS by appending a `<button>` to each `<pre>` element, using `position: absolute` with the pre as relative container

## Decisions Made

- **Red accent color**: Used Apple Calendar's signature red (`#E03E3E`) rather than the blue used in rem's docs
- **Content structure**: 4 pages (getting-started, commands, date-parsing, architecture) — no API or performance pages since cal doesn't expose a public Go API like rem does
- **No wrangler.toml**: Deploy is done entirely via CLI flags in the GH Action, matching rem's approach
- **Hugo version for GH Action**: 0.139.0 (same as rem) rather than the locally installed 0.92

## What's Next

- Map `cal.sidv.dev` to Cloudflare Pages
- Dynamic calendar name completion
- Cross-compile Makefile targets

---

## Session 2 - Interactive Mode Documentation

## Goal

Add interactive mode documentation to the README and the documentation website — it was missing as a dedicated section.

## What Changed

- **README.md**: Added "Interactive Mode" section between Event Selection and Shell Completions, covering guided forms (`-i`) and event picker (zero-arg show/update/delete)
- **website/content/docs/getting-started.md**: Added "Interactive Mode" section with subsections for Guided Forms and Event Picker, including combining picker + form (`cal update -i`)
- **`.gitignore`**: Added `website/public/`, `.hugo_build.lock`, `website/resources/`, `website/.wrangler/` to prevent Hugo build artifacts from being committed (was accidentally committed in initial website commit, cleaned up with `git rm --cached`)

## Key Insights

- Hugo build output (`website/public/`) was initially committed — caught it and added to `.gitignore` with a cleanup commit
- The GH Action rebuilds from source anyway, so `public/` in the repo was pure bloat (4800+ deleted lines)

## Decisions Made

- Split interactive mode docs into two sub-concepts: **guided forms** (`-i` flag on add/update) and **event picker** (zero-arg on show/update/delete) — these are distinct UX patterns even though both use charmbracelet/huh

---
