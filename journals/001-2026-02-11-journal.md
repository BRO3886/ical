# Journal Entry 001 - 2026-02-11 - Initial Build: Complete CLI from Scratch

## Goal
Build the complete `cal` CLI from a blank repo (empty directory scaffolding only) to a fully working macOS Calendar CLI per the PRD. All commands, tests, README, LICENSE. Push to private repo on BRO3886.

## What Changed
- **Project scaffolding**: `go.mod` (github.com/BRO3886/cal), `main.go` with macOS guard + ldflags version, `root.go` with `--output`/`--no-color` global flags, `Makefile` with build/test/install/completions targets
- **Date parser** (`internal/parser/date.go`): Adapted from `rem` project's parser. Key changes from rem: accepts a `now` parameter via `ParseDateRelativeTo()` for testable parsing, defaults dates to 00:00 instead of 09:00 (calendar vs reminders), added "X ago" support, month+day parsing (`mar 15`), standalone weekday parsing, "eow" as same-Friday when on Friday
- **Output formatting** (`internal/ui/output.go`): Table (tablewriter v1.x new API), JSON, plain formats. `localizeTime()` converts UTC times from EventKit to event's timezone or local fallback
- **All 12 commands**: calendars, list, today, upcoming, show, add, update, delete, search, export, import, version — plus cobra completion built-in
- **Export/import** (`internal/export/`): JSON, CSV, ICS (RFC 5545) export. JSON + CSV import with `--dry-run`
- **`--exclude-calendar`** flag on list/today/upcoming: case-insensitive exclusion of noisy calendars
- **Tests**: 80+ parser tests (93.2% coverage), 12 export tests (60.1%), 6 UI tests. Timezone edge cases: DST transitions (spring forward/fall back), half-hour offsets (IST UTC+5:30, Nepal UTC+5:45), international date line (Auckland, Samoa), negative UTC offsets (Hawaii), year/month boundaries, leap years, midnight boundaries
- **README.md** with full documentation, **LICENSE** (MIT)
- Pushed to private repo `github.com/BRO3886/cal`

## Key Insights
- **EventKit returns UTC times**: All `StartDate`/`EndDate` from go-eventkit are in UTC. Must convert to local time for display. Used `localizeTime()` that checks event's `TimeZone` field first, falls back to `time.Local`. This was a bug in the first build — times showed as UTC (04:30 instead of 10:00 IST).
- **`.gitignore` `cal` entry matched `cmd/cal/`**: Had to change `cal` to `/cal` to only ignore the binary at root, not the entire `cmd/cal/` directory.
- **Prefix ID matching**: Events from EventKit share common prefix UUIDs within the same source (e.g., `7E799987-...` prefixed all iCloud events in testing). Need to use the full colon-separated ID format for reliable matching. The `findEventByPrefix()` searches a +-1 year window for matches.
- **tablewriter v1.x API**: Uses `NewTable()`, `.Header()`, `.Append()`, `.Render()` — NOT the old `SetHeader()`/`SetBorder()` API. Alignment via `tw.CellConfig{Formatting: tw.CellFormatting{Alignment: tw.AlignLeft}}`.
- **`calendar.Alert.RelativeOffset`**: Negative means before event. When creating, pass `-duration`. When displaying, negate to get positive.
- **Recurrence `Weekday.String()`**: Returns lowercase (`"mon"`, `"wed"`), not title case. Tests must match this.

## Decisions Made
- **Parser adapted from rem, not copied**: rem's parser uses `time.Now()` internally and defaults to 9 AM. For cal, added `ParseDateRelativeTo()` that accepts `now` for testability, and defaults to 00:00 (calendar events need explicit times).
- **`--exclude-calendar` as StringArray**: Allows `--exclude-calendar Birthdays --exclude-calendar "US Holidays"` syntax. Case-insensitive matching for user convenience.
- **No interactive mode yet**: Deferred `-i` flag for add/update to keep initial build focused. Can add in Phase 3.
- **Event prefix search window**: +-1 year from now. Could be made configurable but covers most use cases without performance issues.

---

## Session 2 - Interactive Mode with charmbracelet/huh

### Goal
Implement `-i`/`--interactive` flag on `add` and `update` commands for guided event creation/editing, using `charmbracelet/huh` for a modern form-based TUI.

### What Changed
- **`cmd/cal/commands/add.go`**: Added `--interactive`/`-i` flag. `runAddInteractive()` presents a 3-page `huh.Form`:
  - Page 1 (Essentials): Title (validated non-empty), Calendar (`huh.Select` from writable cals), Start (validated with `parser.ParseDate`), End (optional, defaults to start+1h), All-day (`huh.Confirm`)
  - Page 2 (Details): Location, Notes, URL, Alerts (comma-separated string like `15m, 1h`), Timezone (validated with `time.LoadLocation`)
  - Page 3 (Recurrence): Repeat frequency (`Select`: none/daily/weekly/monthly/yearly), Repeat days (for weekly)
  - `buildCalendarOptions()` helper builds `huh.Option[string]` list filtering out read-only calendars
- **`cmd/cal/commands/update.go`**: Added `--interactive`/`-i` flag. `runUpdateInteractive()` pre-fills all form fields with current event values:
  - Same 3-page structure as add, plus a span page for recurring events (`Select`: "This event only" / "This and future events")
  - Only changed fields are sent in `UpdateEventInput` (nil for unchanged)
  - Type `-` in Location/Notes/URL to explicitly clear a field
  - `buildAlertSummary()` and `formatAlertDurationShort()` for displaying current alerts
  - `localizeEventTime()` for converting EventKit UTC times to display
- **Initially created `helpers.go`**, then removed it — inlined the 3 functions into add.go and update.go since they were small and only used in one or two places
- Flag-based mode on both commands is completely unchanged

### Key Insights
- **Started with `bufio.NewReader`** (matching `rem` pattern), user preferred `charmbracelet/huh` for better UX — arrow-key selection, inline validation, multi-page forms
- **`huh.ErrUserAborted`** is returned on Ctrl+C — must handle gracefully instead of returning as error
- **`huh.NewOption(label, value).Selected(true)`** pre-selects the current calendar in update mode
- **Alerts as comma-separated string** rather than multi-prompt loop — simpler with huh since it's a single Input field. Parsed after form submission with `strings.Split` + `parser.ParseAlertDuration`
- **Theme**: Using `huh.ThemeCatppuccin()` for consistent styling
- **Separate helpers file wasn't needed** — only 3 small functions, better to colocate with usage

### Decisions Made
- **`charmbracelet/huh` over `bufio`/`promptui`/`survey`**: User chose huh for modern Charm ecosystem UX. Adds ~15 transitive deps but provides Select menus, inline validation, and form-based flow
- **No separate helpers file**: Functions are small enough to live in the files that use them. `buildCalendarOptions` in add.go (also used conceptually in update.go but each file imports huh independently), alert helpers in update.go
- **Alerts as single comma-separated input**: Rather than a loop for multiple alerts, a single field with comma separation works better with huh's form model
- **Recurrence simplified in interactive mode**: No interval/until/count prompts — just frequency + days. Users needing fine-grained recurrence control can use flags directly

---

## Session 3 - Event ID Visibility & Disambiguation

### Goal
Fix the critical UX gap where `cal list`/`today`/`upcoming` showed no event IDs, making it impossible to use `cal show`/`update`/`delete` without guessing. Also fix ID prefix collisions where events from the same source share the first 8 chars of their UUID.

### What Changed
- **`internal/ui/output.go`**: Added "ID" column to `printEventsTable()` as the first column. Added short ID prefix to `printEventsPlain()` output lines. Both use `ShortID()`.
- **`ShortID()` increased from 8 to 13 chars**: Now covers two UUID segments (e.g. `577B8983-DF44`) instead of just the first (`577B8983`). This disambiguates events from the same source — the first segment is shared across all events from a given EventKit source (iCloud, Google, etc.).
- **`cmd/cal/commands/show.go`**: Disambiguation message in `findEventByPrefix()` now shows 22 chars (3 UUID segments) instead of 8, so users can copy a longer prefix when multiple events still match.
- **`internal/ui/output_test.go`**: Updated `TestShortID` cases for 13-char length, added real-world UUID test case.
- **`internal/parser/date.go`**: Added `"this week"` keyword (Sunday 23:59, distinct from `"eow"` which targets Friday 5pm). Added comprehensive doc comment to `ParseDateRelativeTo()` listing all supported input formats. Improved error message with more examples.
- **`internal/parser/date_test.go`**: Added tests for `"this week"` keyword covering weekday, Saturday, and Sunday edge cases.

### Key Insights
- **8-char short IDs are useless for same-source events**: EventKit event IDs are structured as `<source-UUID>:<event-specific-part>`. All events from Google Calendar shared prefix `577B8983`, making `ShortID` identical. The second UUID segment (`-DF44`, `-966E`, etc.) is where they diverge.
- **13 chars is the sweet spot**: Covers `XXXXXXXX-XXXX` (two UUID segments with hyphen separator). Enough to disambiguate without cluttering the table. The disambiguation fallback shows 22 chars for the rare case of further collision.
- **JSON output already had full IDs**: Only table and plain formats were missing IDs.

### Decisions Made
- **13-char short ID over variable-length**: Considered dynamic length based on collision detection, but fixed 13 chars is simpler and sufficient — the second UUID segment provides enough entropy.
- **22-char disambiguation display**: When multiple events match a prefix, show 3 UUID segments so users can always pick a unique prefix. This is only shown in the error path so longer IDs are acceptable.
- **ID as first column in table**: Placed before Time since it's the primary key users need for further commands. Easy to spot and copy.

---
