# Journal Entry 004 - 2026-02-16 - Agent Skills Distribution & Update Check

## Goal

Ship embedded agent skills as a CLI feature (`ical skills install/uninstall/status`) and add a background update check that notifies users of new releases. Also create a PRD for the feature and update all documentation.

## What Changed

### New packages
- **`skills.go`** (module root): `go:embed skills/cal-cli` — embeds the entire skill directory into the binary. Exports `EmbeddedSkills` as `embed.FS`.
- **`internal/skills/skills.go`**: Core logic for Install, Uninstall, IsInstalled, InstalledVersion, DetectAgents, InstalledTargets, DisplayPath. Fully testable — no cobra dependency, accepts `fs.FS` and `AgentTarget` structs.
- **`internal/update/check.go`**: Background update check — cache parsing/writing (`~/.cache/ical/update-check`), GitHub API fetch with context timeout, semver comparison. `Check()` is the main entry point — reads cache, fetches if stale, writes cache, returns `*Result`.
- **`cmd/ical/commands/skills.go`**: Cobra command with `install`, `uninstall`, `status` subcommands. Interactive `huh.NewMultiSelect` for agent target selection. `--agent` flag for non-interactive use.

### Modified files
- **`cmd/ical/commands/root.go`**: Added `PersistentPreRun` goroutine for background update check + `PersistentPostRun` for printing notices to stderr. Channel-based communication (`updateResultCh`). Skip conditions: `ICAL_NO_UPDATE_CHECK`, dev builds, json output, piped stdout, meta commands.
- **`scripts/install.sh`** + **`website/static/install`**: Added post-install prompt for skill installation. Uses `read -r answer < /dev/tty` to work in curl-pipe-bash context.
- **`docs/prd/cal-cli-prd.md`**: Marked as DONE.
- **`docs/prd/skills-and-update-prd.md`**: New PRD — went through multiple iterations: started with self-update command, dropped it (too many install methods = too many edge cases), settled on background check + skills management.

### Documentation updates
- `skills/cal-cli/SKILL.md`: Added skills commands to command table
- `skills/cal-cli/references/commands.md`: Full `ical skills` section + `ICAL_NO_UPDATE_CHECK` env var
- `README.md`: Added skills commands to table, new "AI Agent Skills" section, updated architecture tree
- `website/content/docs/commands.md`: Skills commands in overview + full section, fixed "iical" typo
- `website/content/docs/getting-started.md`: New "AI Agent Skills" section
- `website/content/docs/architecture.md`: Updated project tree, new design decision sections

### Test coverage
- `internal/skills/skills_test.go`: 15 tests, 83.6% coverage — install, uninstall, overwrite, symlink replacement, version tracking, agent detection
- `internal/update/check_test.go`: 15 tests, 89.5% coverage — cache parsing, freshness, version comparison, GitHub API error handling
- `skills_test.go`: 3 integration tests for embedded FS — verifies `go:embed` loads real files
- All tests pass with `-race` flag

## Key Insights

- **`go:embed` constraint**: Can only embed relative to the source file's directory. Putting `skills.go` at module root is the pragmatic choice — the only consumer is `cmd/ical/commands/skills.go` which imports the root package. Yes, it leaks `EmbeddedSkills` into the public API, but nobody imports `github.com/BRO3886/ical` as a library.
- **Agent skill paths**: Two directories cover ~90% of AI coding agents: `~/.claude/skills/` (Claude Code, Copilot, Cursor, OpenCode, Augment) and `~/.agents/skills/` (Codex CLI, Copilot, Windsurf, OpenCode, Augment). The Agent Skills standard (agentskills.io) is adopted by all major tools.
- **Self-update dropped**: Too many install methods (go install, curl script, manual) with different binary locations and permission models. The install script is already idempotent — it *is* the update mechanism. Background check + notice is sufficient.
- **Update check is fire-and-forget**: Goroutine in `PersistentPreRun`, non-blocking select in `PersistentPostRun`. If the goroutine isn't done, skip — never delay the user. 2-second context timeout on GitHub API. Cache write failures are silently ignored.
- **`read -r answer < /dev/tty`** in install script: When piped via `curl | bash`, stdin is the script itself. `/dev/tty` reads from the actual terminal. Falls back to "n" if `/dev/tty` is unavailable (non-interactive CI).
- **Skill name is `ical-cli`** (not `cal-cli`): The existing symlink at `~/.claude/skills/cal-cli` is untouched. Install writes to `ical-cli/` — different directory. No conflict.
- **`.ical-version` file**: Written alongside skill files to track which binary version installed them. Enables staleness detection without HTTP — just compare file content against `versionStr`.

## Decisions Made

- **Cache at `~/.cache/ical/`** not `~/.ical-update-check`: Follows XDG conventions, avoids littering home directory with dotfiles. User preferred this over a file in `$HOME`.
- **`huh.NewMultiSelect`** for agent picker: Users can install to multiple agents at once. Pre-checks detected agents (dirs that exist). Consistent with existing interactive patterns (ThemeCatppuccin).
- **No `ical update` command**: Self-update is over-engineered for a tool with 3+ install methods. Let the install script handle it. Version check is the right level of notification.
- **Skills always overwrite on install**: Binary is the source of truth. No merge, no diff, no conflict resolution.
- **Stderr for notices**: Update check and skills staleness notices go to stderr, not stdout. This prevents interference with piped output (`ical today -o json | jq`).
- **PRD marked as DONE**: `cal-cli-prd.md` now has status header. New `skills-and-update-prd.md` covers the new feature.

---
